// CORE INPUTS
function getCoreInputs() {
    const journeyMiles = parseFloat(document.getElementById("journeyMiles").value);
    const batteryKwh = parseFloat(document.getElementById("batteryKwh").value);
    const soc = parseFloat(document.getElementById("soc").value);
    const efficiency = parseFloat(document.getElementById("efficiency").value);
    const adhocPence = parseFloat(document.getElementById("adhoc").value);
    const homeRatePence = parseFloat(document.getElementById("homeRate").value);
    const cheapHome = document.getElementById("cheapHome").checked;

    if (!journeyMiles || !batteryKwh || !soc || !efficiency || !adhocPence) return null;

    let usableKwhAtStart = 0;
    let homeMiles = 0;
    let publicMiles = journeyMiles;

    if (cheapHome) {
        usableKwhAtStart = batteryKwh * (soc / 100);
        homeMiles = usableKwhAtStart * efficiency;
        publicMiles = Math.max(0, journeyMiles - homeMiles);
    }

    const publicKwh = publicMiles / efficiency;
    const adhocRate = adhocPence / 100;
    const adhocCost = publicKwh * adhocRate;

    const homeKwh = cheapHome ? usableKwhAtStart : 0;
    const homeRate = !isNaN(homeRatePence) ? homeRatePence / 100 : 0;
    const homeCost = homeKwh * homeRate;

    const blendedAdhocTripCost = homeCost + adhocCost;
    const blendedAdhocCostPerMile = blendedAdhocTripCost / journeyMiles;
    const blendedAdhocCostPer100 = blendedAdhocCostPerMile * 100;

    return {
        journeyMiles,
        batteryKwh,
        soc,
        efficiency,
        adhocPence,
        homeRatePence: isNaN(homeRatePence) ? null : homeRatePence,
        cheapHome,
        usableKwhAtStart,
        homeMiles,
        publicMiles,
        publicKwh,
        adhocRate,
        adhocCost,
        homeKwh,
        homeRate,
        homeCost,
        blendedAdhocTripCost,
        blendedAdhocCostPerMile,
        blendedAdhocCostPer100
    };
}

// MAIN CALCULATION
function calculate() {
    const core = getCoreInputs();

    const homeRangeLine = document.getElementById("homeRangeLine");
    const homeCostLine = document.getElementById("homeCostLine");
    const publicMilesLine = document.getElementById("publicMilesLine");
    const publicKwhLine = document.getElementById("publicKwhLine");
    const adhocCostLine = document.getElementById("adhocCostLine");
    const blendedCostLine = document.getElementById("blendedCostLine");
    const blendedCostPerMileLine = document.getElementById("blendedCostPerMileLine");
    const tableBody = document.querySelector("#providerTable tbody");

    if (!core) {
        homeRangeLine.textContent = "Enter all trip, battery, efficiency and ad‑hoc fields to see calculations.";
        homeCostLine.textContent = "";
        publicMilesLine.textContent = "";
        publicKwhLine.textContent = "";
        adhocCostLine.textContent = "";
        blendedCostLine.textContent = "";
        blendedCostPerMileLine.textContent = "";
        if (tableBody) tableBody.innerHTML = "";
        document.getElementById("results").style.display = "none";
        if (chart) chart.destroy();
        return;
    }

    if (core.cheapHome) {
        homeRangeLine.innerHTML =
            `Estimated range from home charge: <span class="highlight">${core.homeMiles.toFixed(0)} miles</span>`;
        if (core.homeRate > 0 && core.homeKwh > 0) {
            homeCostLine.innerHTML =
                `Home charging energy: <span class="highlight">${core.homeKwh.toFixed(1)} kWh</span>, ` +
                `cost: <span class="highlight">£${core.homeCost.toFixed(2)}</span>`;
        } else if (core.homeKwh > 0) {
            homeCostLine.innerHTML =
                `Home charging energy: <span class="highlight">${core.homeKwh.toFixed(1)} kWh</span> (no home rate entered).`;
        } else {
            homeCostLine.textContent = "";
        }
    } else {
        homeRangeLine.innerHTML = `Home charging disabled — full journey requires public charging.`;
        homeCostLine.textContent = "";
    }

    publicMilesLine.innerHTML =
        `Miles requiring public charging: <span class="highlight">${core.publicMiles.toFixed(0)} miles</span>`;
    publicKwhLine.innerHTML =
        `Energy from public charging: <span class="highlight">${core.publicKwh.toFixed(1)} kWh</span>`;
    adhocCostLine.innerHTML =
        `Cost using ad‑hoc only (public portion): <span class="highlight">£${core.adhocCost.toFixed(2)}</span>`;

    blendedCostLine.innerHTML =
        `Total blended trip cost (home + public, ad‑hoc public rate): <span class="highlight">£${core.blendedAdhocTripCost.toFixed(2)}</span>`;
    blendedCostPerMileLine.innerHTML =
        `Effective ad‑hoc cost per mile: <span class="highlight">${(core.blendedAdhocCostPerMile * 100).toFixed(1)} p/mile</span> ` +
        `(~£${core.blendedAdhocCostPer100.toFixed(2)} per 100 miles)`;

    const providers = [];
    const boxes = document.querySelectorAll(".provider-box");

    boxes.forEach(box => {
        const id = box.dataset.id;
        const name = document.getElementById(`name${id}`).value.trim();
        const subCost = parseFloat(document.getElementById(`subCost${id}`).value);
        const discountPence = parseFloat(document.getElementById(`discount${id}`).value);

        if (!name || isNaN(subCost) || isNaN(discountPence)) return;

        const discountRate = discountPence / 100;

        const costWithSubPublicOnly = subCost + (core.publicKwh * discountRate);
        const breakEvenKwh = (core.adhocRate > discountRate)
            ? subCost / (core.adhocRate - discountRate)
            : Infinity;
        const breakEvenMiles = (breakEvenKwh === Infinity)
            ? Infinity
            : breakEvenKwh * core.efficiency;

        const savingsPublicOnly = core.adhocCost - costWithSubPublicOnly;

        const blendedTripCost = core.homeCost + costWithSubPublicOnly;
        const blendedCostPerMile = blendedTripCost / core.journeyMiles;
        const blendedCostPer100 = blendedCostPerMile * 100;

        const blendedSavingsVsAdhoc = core.blendedAdhocTripCost - blendedTripCost;

        providers.push({
            name,
            costWithSubPublicOnly,
            breakEvenMiles,
            savingsPublicOnly,
            subCost,
            discountPence,
            blendedTripCost,
            blendedCostPerMile,
            blendedCostPer100,
            blendedSavingsVsAdhoc
        });
    });

    if (providers.length === 0) {
        document.getElementById("results").style.display = "none";
        if (tableBody) tableBody.innerHTML = "";
        if (chart) chart.destroy();
        return;
    }

    document.getElementById("results").style.display = "block";

    const best = providers.reduce((a, b) => (a.blendedTripCost < b.blendedTripCost ? a : b));
    const summaryBox = document.getElementById("summaryBox");

    if (best.blendedTripCost < core.blendedAdhocTripCost) {
        summaryBox.className = "summary good";
        summaryBox.textContent =
            `${best.name} is the cheapest option for this trip (saving £${(core.blendedAdhocTripCost - best.blendedTripCost).toFixed(2)} vs ad‑hoc, including home + public).`;
    } else {
        summaryBox.className = "summary bad";
        summaryBox.textContent =
            `Ad‑hoc charging (with your home rate) is cheaper than any subscription for this trip distance.`;
    }

    renderProviderTable(core, providers);
    drawGraph(core, providers);
}

// TABLE RENDERING WITH CORRECT BREAK‑EVEN LOGIC + COST PER MILE
function renderProviderTable(core, providers) {
    const tbody = document.querySelector("#providerTable tbody");
    if (!tbody) return;

    const sortBy = document.getElementById("sortBy")?.value || "cost";
    const showTotal = document.getElementById("showTotalBreakEven")?.checked || false;

    const sorted = [...providers];

    sorted.sort((a, b) => {
        if (sortBy === "cost") return a.blendedTripCost - b.blendedTripCost;
        if (sortBy === "breakeven") {
            if (a.breakEvenMiles === b.breakEvenMiles) return 0;
            if (a.breakEvenMiles === Infinity) return 1;
            if (b.breakEvenMiles === Infinity) return -1;
            return a.breakEvenMiles - b.breakEvenMiles;
        }
        if (sortBy === "savings") return b.blendedSavingsVsAdhoc - a.blendedSavingsVsAdhoc;
        return 0;
    });

    tbody.innerHTML = "";

    sorted.forEach(p => {
        let beText;

        if (p.breakEvenMiles === Infinity) {
            beText = "No break‑even (discounted rate ≥ ad‑hoc rate)";
        } else {
            const be = p.breakEvenMiles;

            if (showTotal) {
                beText = `${be.toFixed(0)} miles (public charging required for break‑even)`;
            } else {
                beText =
                    `${be.toFixed(0)} miles of public charging ` +
                    `(independent of this specific trip)`;
            }
        }

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${p.name}</td>
            <td>£${p.blendedTripCost.toFixed(2)}</td>
            <td>${(p.blendedCostPerMile * 100).toFixed(1)} p/mile</td>
            <td>${beText}</td>
            <td>£${p.blendedSavingsVsAdhoc.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

// GRAPH (blended trip cost vs distance)
function drawGraph(core, providers) {
    const ctx = document.getElementById("costChart");

    if (chart) chart.destroy();

    const maxMiles = core.journeyMiles;
    const steps = 20;

    const labels = [];
    const adhocData = [];

    for (let i = 0; i <= steps; i++) {
        const m = (maxMiles * i) / steps;
        labels.push(m.toFixed(0));

        const homeMilesAtM = core.cheapHome ? Math.min(core.homeMiles, m) : 0;
        const publicMilesAtM = Math.max(0, m - homeMilesAtM);
        const homeKwhAtM = homeMilesAtM / core.efficiency;
        const publicKwhAtM = publicMilesAtM / core.efficiency;

        const homeCostAtM = homeKwhAtM * core.homeRate;
        const adhocCostAtM = publicKwhAtM * core.adhocRate;

        const blendedAdhocAtM = homeCostAtM + adhocCostAtM;

        adhocData.push(blendedAdhocAtM);
    }

    const datasets = [{
        label: "Ad‑hoc (home + public) (£)",
        data: adhocData,
        borderColor: "#f97316",
        backgroundColor: "rgba(249,115,22,0.15)",
        tension: 0.2
    }];

    providers.forEach((p, idx) => {
        const colors = ["#38bdf8", "#4ade80", "#a855f7", "#facc15", "#f472b6", "#22c55e"];
        const color = colors[idx % colors.length];

        const data = [];

        for (let i = 0; i <= steps; i++) {
            const m = (maxMiles * i) / steps;

            const homeMilesAtM = core.cheapHome ? Math.min(core.homeMiles, m) : 0;
            const publicMilesAtM = Math.max(0, m - homeMilesAtM);
            const homeKwhAtM = homeMilesAtM / core.efficiency;
            const publicKwhAtM = publicMilesAtM / core.efficiency;

            const homeCostAtM = homeKwhAtM * core.homeRate;
            const subCostAtM = p.subCost + (publicKwhAtM * (p.discountPence / 100));

            const blendedAtM = homeCostAtM + subCostAtM;

            data.push(blendedAtM);
        }

        datasets.push({
            label: `${p.name} (£)`,
            data,
            borderColor: color,
            backgroundColor: "transparent",
            tension: 0.2
        });
    });

    chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
                x: { title: { display: true, text: "Trip distance (miles)" } },
                y: { title: { display: true, text: "Total blended trip cost (£)" }, beginAtZero: true }
            }
        }
    });
}

// SHAREABLE LINK
function shareLink() {
    const core = getCoreInputs();
    if (!core) {
        alert("Please fill in all main inputs first.");
        return;
    }

    const params = new URLSearchParams();

    params.set("jm", core.journeyMiles);
    params.set("bk", core.batteryKwh);
    params.set("soc", core.soc);
    params.set("eff", core.efficiency);
    params.set("adhoc", core.adhocPence);
    if (core.homeRatePence !== null) params.set("hr", core.homeRatePence);
    params.set("ch", core.cheapHome ? "1" : "0");

    let idx = 0;
    document.querySelectorAll(".provider-box").forEach(box => {
        const id = box.dataset.id;

        const name = document.getElementById(`name${id}`).value.trim();
        const subCost = document.getElementById(`subCost${id}`).value;
        const discount = document.getElementById(`discount${id}`).value;

        if (!name || !subCost || !discount) return;

        params.set(`p${idx}n`, name);
        params.set(`p${idx}s`, subCost);
        params.set(`p${idx}r`, discount);

        idx++;
    });

    const base = window.location.href.split("?")[0];
    const url = `${base}?${params.toString()}`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(
            () => alert("Link copied to clipboard."),
            () => prompt("Copy this link:", url)
        );
    } else {
        prompt("Copy this link:", url);
    }
}

// LOAD FROM URL
function loadFromParams() {
    const params = new URLSearchParams(window.location.search);

    if (!params.has("jm")) return;

    const setVal = (id, key) => {
        const v = params.get(key);
        if (v !== null) document.getElementById(id).value = v;
    };

    setVal("journeyMiles", "jm");
    setVal("batteryKwh", "bk");
    setVal("soc", "soc");
    setVal("efficiency", "eff");
    setVal("adhoc", "adhoc");
    setVal("homeRate", "hr");

    const ch = params.get("ch");
    if (ch === "0") document.getElementById("cheapHome").checked = false;
    if (ch === "1") document.getElementById("cheapHome").checked = true;

    let idx = 0;
    while (true) {
        const name = params.get(`p${idx}n`);
        const sub = params.get(`p${idx}s`);
        const rate = params.get(`p${idx}r`);

        if (!name || !sub || !rate) break;

        createProviderBox();
        const id = providerCount;

        document.getElementById(`name${id}`).value = name;
        document.getElementById(`subCost${id}`).value = sub;
        document.getElementById(`discount${id}`).value = rate;

        idx++;
    }

    calculate();
}

// PDF EXPORT
async function exportPdf() {
    const resultsEl = document.getElementById("results");
    if (!resultsEl || resultsEl.style.display === "none") {
        alert("Please enter inputs and providers so results are visible before exporting.");
        return;
    }

    resultsEl.scrollIntoView();
    await new Promise(r => setTimeout(r, 300));

    const { jsPDF } = window.jspdf;

    const canvas = await html2canvas(document.body, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
    });

    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    pdf.save("ev-charging-comparison.pdf");
}

// INITIALISE
["journeyMiles","batteryKwh","soc","efficiency","adhoc","homeRate"].forEach(id => {
    document.getElementById(id).addEventListener("input", calculate);
});
document.getElementById("cheapHome").addEventListener("change", calculate);
document.getElementById("sortBy").addEventListener("change", calculate);
document.getElementById("showTotalBreakEven").addEventListener("change", calculate);

initTheme();
addProvider();
loadFromParams();
</script>
</body>
</html>
