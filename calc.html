<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EV Public Charging Comparison</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg: #020617;
            --panel: #020617;
            --panel-alt: #020617;
            --accent: #38bdf8;
            --accent-soft: rgba(56,189,248,0.15);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f2937;
            --danger: #f97373;
            --good: #22c55e;
        }

        body.light {
            --bg: #f3f4f6;
            --panel: #ffffff;
            --panel-alt: #f9fafb;
            --accent: #0ea5e9;
            --accent-soft: rgba(14,165,233,0.12);
            --text: #111827;
            --muted: #6b7280;
            --border: #d1d5db;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light {
            background: radial-gradient(circle at top, #e5e7eb 0, #f3f4f6 45%, #e5e7eb 100%);
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            background: radial-gradient(circle at top left, #0b1120 0, #020617 55%, #000 100%);
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: 0 24px 80px rgba(0,0,0,0.7);
            padding: 24px 24px 32px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light .app {
            background: radial-gradient(circle at top left, #ffffff 0, #f9fafb 55%, #e5e7eb 100%);
            border-color: var(--border);
            box-shadow: 0 18px 50px rgba(15,23,42,0.15);
        }

        h1 { margin: 0 0 4px; font-size: 1.6rem; letter-spacing: 0.03em; }
        .subtitle { margin-bottom: 20px; color: var(--muted); font-size: 0.9rem; }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .theme-toggle {
            font-size: 0.8rem;
            color: var(--muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle input {
            cursor: pointer;
        }

        .btn.top-reset {
            margin-left: 12px;
            background: transparent;
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
            gap: 20px;
        }

        .card {
            background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 12px 14px 14px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light .card {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            border-color: var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .card-header h2 {
            margin: 0;
            font-size: 0.95rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .collapse-btn {
            border-radius: 999px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-size: 0.75rem;
            padding: 3px 8px;
            cursor: pointer;
        }

        .collapse-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .card-body {
            margin-top: 6px;
        }

        .section-note {
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .input-group label { font-size: 0.8rem; color: var(--muted); }

        .input-group input,
        .input-group select {
            background: var(--panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 7px 9px;
            color: var(--text);
            font-size: 0.85rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .provider-header span { font-size: 0.85rem; color: var(--muted); }

        .provider-header button {
            background: transparent;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 0.75rem;
            padding: 3px 8px;
            cursor: pointer;
        }

        .provider-header button:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .provider-box {
            background: var(--panel);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 10px 10px 8px;
            margin-bottom: 10px;
        }

        .providers-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, #0ea5e9, #0369a1);
            color: white;
            font-size: 0.8rem;
            padding: 6px 12px;
            cursor: pointer;
        }

        .btn.danger {
            background: transparent;
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .results { margin-top: 16px; display: none; }

        .summary {
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .summary.good {
            background: rgba(22,163,74,0.12);
            border: 1px solid rgba(34,197,94,0.5);
            color: #bbf7d0;
        }

        .summary.bad {
            background: rgba(220,38,38,0.12);
            border: 1px solid rgba(248,113,113,0.6);
            color: #fecaca;
        }

        body.light .summary.good {
            background: rgba(22,163,74,0.08);
            color: #166534;
        }

        body.light .summary.bad {
            background: rgba(220,38,38,0.08);
            color: #b91c1c;
        }

        .highlight { color: var(--accent); font-weight: 500; }

        .calc-lines { font-size: 0.82rem; color: var(--text); margin-bottom: 10px; }
        .calc-lines div { margin-bottom: 3px; }

        .providers-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input-group-inline {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .provider-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 0.82rem;
        }

        .provider-table th,
        .provider-table td {
            border: 1px solid var(--border);
            padding: 6px 8px;
            text-align: left;
        }

        .provider-table th {
            background: var(--panel-alt);
            color: var(--muted);
            font-weight: 500;
        }

        .info {
            font-size: 0.75rem;
            margin-left: 4px;
            cursor: help;
            color: var(--muted);
        }

        .chart-wrapper {
            margin-top: 10px;
            background: var(--panel);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 10px;
        }

        canvas { max-width: 100%; }

        @media (max-width: 800px) {
            .grid { grid-template-columns: minmax(0, 1fr); }
        }
    </style>
</head>
<body>
<div class="app">

    <div class="top-bar">
        <div>
            <h1>EV Public Charging Comparison</h1>
            <div class="subtitle">
                Use this tool to compare ad‑hoc vs subscription charging for specific trip distances 
                (e.g., a weekend away or a seven-day break in another area).<br /><br />
                Select pre-set providers, edit default values, and/or add your own custom provider(s).<br /><br />
                <strong>Note:</strong> default provider values are hard-coded (not live or dynamically generated). 
                Message the page author to suggest corrections.
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:12px;">

            <label class="theme-toggle">
                <input type="checkbox" id="themeToggle">
                <span>Light mode</span>
            </label>

            <button type="button" class="btn danger top-reset" onclick="resetAll()">Reset all</button>

            <a href="https://www.facebook.com/kelvin.a.hill"
               target="_blank"
               class="btn secondary"
               style="text-decoration:none;">
                Message Author
            </a>

        </div>
    </div>

    <div class="grid">

        <!-- Trip & vehicle -->
        <div class="card">
            <div class="card-header">
                <h2>Trip & Vehicle</h2>
                <button type="button" class="collapse-btn" onclick="toggleSection('tripSection')">Toggle</button>
            </div>

            <div class="card-body" id="tripSection">
                <div class="input-row">
                    <div class="input-group">
                        <label>Trip distance (miles)</label>
                        <input type="number" id="journeyMiles" placeholder="e.g., 250">
                    </div>
                    <div class="input-group">
                        <label>Battery size (kWh)</label>
                        <input type="number" id="batteryKwh" placeholder="e.g., 61">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>Starting state of charge (%)</label>
                        <input type="number" id="soc" placeholder="e.g., 90">
                    </div>
                    <div class="input-group">
                        <label>Efficiency (miles per kWh)</label>
                        <input type="number" id="efficiency" placeholder="e.g., 3.5">
                    </div>
                </div>

                <div class="input-group">
                    <label>Ad‑hoc public rate (pence per kWh)</label>
                    <input type="number" id="adhoc" placeholder="e.g., 62 [from Lidl using the Lidl+ app]">
                </div>

                <div class="input-group">
                    <label>Home charging rate (pence per kWh)</label>
                    <input type="number" id="homeRate" placeholder="e.g., 30">
                </div>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="cheapHome" checked>
                        I have cheap home charging
                    </label>
                </div>
            </div>
        </div>

        <!-- Providers -->
        <div class="card">
            <div class="card-header">
                <h2>Subscriptions & Discounts</h2>
                <button type="button" class="collapse-btn" onclick="toggleSection('providersSection')">Toggle</button>
            </div>

            <div class="card-body" id="providersSection">

                <!-- ⭐ Explanatory note now BELOW the title -->
                <div class="section-note">
                    <strong>Note:</strong> choose providers available in your area of travel.
                </div>

                <div class="providers-header-row">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn" onclick="addProvider()">Add provider</button>
                        <button type="button" class="btn secondary" onclick="addAllProviders()">Add all providers</button>
                        <button type="button" class="btn secondary" onclick="duplicateLastProvider()">Duplicate last</button>
                    </div>
                </div>

                <div id="providers"></div>
            </div>
        </div>

    </div>

    <div class="btn-row">
        <button type="button" class="btn secondary" onclick="shareLink()">Copy shareable link</button>
        <button type="button" class="btn secondary" onclick="exportPdf()">Export as PDF</button>
    </div>

    <!-- Results -->
    <div class="card results" id="results">
        <div class="card-header">
            <h2>Results</h2>
            <button type="button" class="collapse-btn" onclick="toggleSection('resultsSection')">Toggle</button>
        </div>

        <div class="card-body" id="resultsSection">
            <div id="summaryBox" class="summary"></div>

            <div class="calc-lines">
                <div id="homeRangeLine"></div>
                <div id="homeCostLine"></div>
                <div id="publicMilesLine"></div>
                <div id="publicKwhLine"></div>
                <div id="adhocCostLine"></div>
                <div id="blendedCostLine"></div>
                <div id="blendedCostPerMileLine"></div>
            </div>

            <div class="providers-controls">
                <div class="input-group-inline">
                    <label for="sortBy">Sort providers</label>
                    <select id="sortBy">
                        <option value="cost">Cheapest first</option>
                        <option value="breakeven">Break‑even miles</option>
                        <option value="savings">Savings (highest first)</option>
                    </select>
                </div>

                <div class="input-group-inline">
                    <label>
                        <input type="checkbox" id="showTotalBreakEven">
                        Show total break‑even miles only
                    </label>
                </div>
            </div>

            <table id="providerTable" class="provider-table">
                <thead>
                <tr>
                    <th>Provider</th>
                    <th>Trip cost (£)</th>
                    <th>Cost per mile (p)</th>
                    <th>
                        Break‑even
                        <span class="info"
                              title="Break‑even is the amount of public charging required before a subscription becomes cheaper than paying ad‑hoc. It is independent of the specific trip distance you enter.">
                            ⓘ
                        </span>
                    </th>
                    <th>Savings vs ad‑hoc (£)</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="chart-wrapper">
                <canvas id="costChart" height="220"></canvas>
            </div>
        </div>
    </div>
</div>
<script>
/* =========================================================
   PRESETS (fallback) + JSON LOADING
========================================================= */
const PRESETS_FALLBACK = [
    { name: "Tesla", subCost: 10.99, rate: 45 },
    { name: "BP Pulse", subCost: 7.99, rate: 49 },
    { name: "Osprey", subCost: 0, rate: 79 },
    { name: "Instavolt", subCost: 0, rate: 85 },
    { name: "Gridserve", subCost: 0, rate: 79 },
    { name: "Shell Recharge", subCost: 7.99, rate: 55 },
    { name: "Be.EV", subCost: 9.99, rate: 39 }
];

let PRESETS = [...PRESETS_FALLBACK];

function buildPresetOptions() {
    const names = ["Custom", ...PRESETS.map(p => p.name)];
    return names.map(name => `<option value="${name}">${name}</option>`).join("");
}

function refreshPresetDropdowns() {
    document.querySelectorAll(".provider-box").forEach(box => {
        const id = box.dataset.id;
        const select = document.getElementById(`preset${id}`);
        if (!select) return;
        const current = select.value;
        select.innerHTML = buildPresetOptions();
        select.value = current;
    });
}

// Load JSON from correct path with cache-busting
fetch("data/providers.json?cache=" + Date.now())
    .then(r => r.json())
    .then(data => {
        if (Array.isArray(data.providers)) {
            PRESETS = data.providers.map(p => ({
                name: p.name,
                subCost: p.subCost ?? 0,
                rate: p.rate ?? 0
            }));
            refreshPresetDropdowns();
        }
    })
    .catch(() => console.warn("Using built‑in presets; providers.json not found."));

let providerCount = 0;
let chart = null;

/* =========================================================
   THEME TOGGLE
========================================================= */
function initTheme() {
    const toggle = document.getElementById("themeToggle");
    const stored = localStorage.getItem("evCalcTheme");
    if (stored === "light") {
        document.body.classList.add("light");
        if (toggle) toggle.checked = true;
    }
    if (toggle) {
        toggle.addEventListener("change", () => {
            if (toggle.checked) {
                document.body.classList.add("light");
                localStorage.setItem("evCalcTheme", "light");
            } else {
                document.body.classList.remove("light");
                localStorage.setItem("evCalcTheme", "dark");
            }
        });
    }
}

/* =========================================================
   COLLAPSIBLE SECTIONS
========================================================= */
function toggleSection(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = (el.style.display === "none") ? "block" : "none";
}

/* =========================================================
   PROVIDER UI
========================================================= */
function createProviderBox(preset) {
    providerCount++;
    const id = providerCount;

    const box = document.createElement("div");
    box.className = "provider-box";
    box.dataset.id = id;

    const presetOptions = buildPresetOptions();

    box.innerHTML = `
        <div class="provider-header">
            <span>Provider #${id}</span>
            <div style="display:flex; gap:6px;">
                <button type="button" onclick="duplicateProvider(${id})">Duplicate</button>
                <button type="button" onclick="removeProvider(${id})">Remove</button>
            </div>
        </div>

        <div class="input-group">
            <label>Preset</label>
            <select id="preset${id}">
                ${presetOptions}
            </select>
        </div>

        <div class="input-group">
            <label>Provider name</label>
            <input type="text" id="name${id}" placeholder="e.g., BP Pulse">
        </div>

        <div class="input-group">
            <label>Subscription cost (£ / month)</label>
            <input type="number" id="subCost${id}" placeholder="e.g., 7.99">
        </div>

        <div class="input-group">
            <label>Subscription discounted rate (pence per kWh)</label>
            <input type="number" id="discount${id}" placeholder="e.g., 49">
        </div>
    `;

    document.getElementById("providers").appendChild(box);

    const presetSelect = document.getElementById(`preset${id}`);
    presetSelect.addEventListener("change", () => applyPreset(id));

    box.querySelectorAll("input").forEach(i => i.addEventListener("input", calculate));

    if (preset) {
        presetSelect.value = preset.name;
        document.getElementById(`name${id}`).value = preset.name;
        document.getElementById(`subCost${id}`).value = preset.subCost;
        document.getElementById(`discount${id}`).value = preset.rate;
    }
}

function addProvider() {
    createProviderBox();
    calculate();
}

function addAllProviders() {
    const existing = Array.from(document.querySelectorAll(".provider-box"))
        .map(b => document.getElementById(`name${b.dataset.id}`).value.trim().toLowerCase());

    PRESETS.forEach(p => {
        if (!existing.includes(p.name.toLowerCase())) {
            createProviderBox(p);
        }
    });

    calculate();
}

function removeProvider(id) {
    const box = document.querySelector(`.provider-box[data-id="${id}"]`);
    if (box) box.remove();
    calculate();
}

function applyPreset(id) {
    const presetName = document.getElementById(`preset${id}`).value;
    const preset = PRESETS.find(p => p.name === presetName);
    if (!preset) return;

    document.getElementById(`name${id}`).value = preset.name;
    document.getElementById(`subCost${id}`).value = preset.subCost;
    document.getElementById(`discount${id}`).value = preset.rate;

    calculate();
}

function duplicateProvider(id) {
    const name = document.getElementById(`name${id}`).value;
    const subCost = document.getElementById(`subCost${id}`).value;
    const discount = document.getElementById(`discount${id}`).value;

    createProviderBox();
    const newId = providerCount;

    document.getElementById(`name${newId}`).value = name;
    document.getElementById(`subCost${newId}`).value = subCost;
    document.getElementById(`discount${newId}`).value = discount;

    calculate();
}

function duplicateLastProvider() {
    const boxes = document.querySelectorAll(".provider-box");
    if (!boxes.length) return;
    const last = boxes[boxes.length - 1];
    duplicateProvider(last.dataset.id);
}

function resetAll() {
    document.getElementById("journeyMiles").value = "";
    document.getElementById("batteryKwh").value = "";
    document.getElementById("soc").value = "";
    document.getElementById("efficiency").value = "";
    document.getElementById("adhoc").value = "";
    document.getElementById("homeRate").value = "";
    document.getElementById("cheapHome").checked = true;

    document.getElementById("providers").innerHTML = "";
    providerCount = 0;
    addProvider();

    document.getElementById("sortBy").value = "cost";
    document.getElementById("showTotalBreakEven").checked = false;

    calculate();
}
</script>
<!-- =========================================================
     CORE INPUTS
========================================================= -->
function getCoreInputs() {
    const journeyMiles = parseFloat(document.getElementById("journeyMiles").value);
    const batteryKwh = parseFloat(document.getElementById("batteryKwh").value);
    const soc = parseFloat(document.getElementById("soc").value);
    const efficiency = parseFloat(document.getElementById("efficiency").value);
    const adhocPence = parseFloat(document.getElementById("adhoc").value);
    const homeRatePence = parseFloat(document.getElementById("homeRate").value);
    const cheapHome = document.getElementById("cheapHome").checked;

    if (!journeyMiles || !batteryKwh || !soc || !efficiency || !adhocPence) return null;

    let usableKwhAtStart = 0;
    let homeMiles = 0;
    let publicMiles = journeyMiles;

    if (cheapHome) {
        usableKwhAtStart = batteryKwh * (soc / 100);
        homeMiles = usableKwhAtStart * efficiency;
        publicMiles = Math.max(0, journeyMiles - homeMiles);
    }

    const publicKwh = publicMiles / efficiency;
    const adhocRate = adhocPence / 100;
    const adhocCost = publicKwh * adhocRate;

    const homeKwh = cheapHome ? usableKwhAtStart : 0;
    const homeRate = !isNaN(homeRatePence) ? homeRatePence / 100 : 0;
    const homeCost = homeKwh * homeRate;

    const blendedAdhocTripCost = homeCost + adhocCost;
    const blendedAdhocCostPerMile = blendedAdhocTripCost / journeyMiles;
    const blendedAdhocCostPer100 = blendedAdhocCostPerMile * 100;

    return {
        journeyMiles,
        batteryKwh,
        soc,
        efficiency,
        adhocPence,
        homeRatePence: isNaN(homeRatePence) ? null : homeRatePence,
        cheapHome,
        usableKwhAtStart,
        homeMiles,
        publicMiles,
        publicKwh,
        adhocRate,
        adhocCost,
        homeKwh,
        homeRate,
        homeCost,
        blendedAdhocTripCost,
        blendedAdhocCostPerMile,
        blendedAdhocCostPer100
    };
}

<!-- =========================================================
     MAIN CALCULATION
========================================================= -->
function calculate() {
    const core = getCoreInputs();

    const homeRangeLine = document.getElementById("homeRangeLine");
    const homeCostLine = document.getElementById("homeCostLine");
    const publicMilesLine = document.getElementById("publicMilesLine");
    const publicKwhLine = document.getElementById("publicKwhLine");
    const adhocCostLine = document.getElementById("adhocCostLine");
    const blendedCostLine = document.getElementById("blendedCostLine");
    const blendedCostPerMileLine = document.getElementById("blendedCostPerMileLine");
    const tableBody = document.querySelector("#providerTable tbody");

    if (!core) {
        homeRangeLine.textContent = "Enter all trip, battery, efficiency and ad‑hoc fields to see calculations.";
        homeCostLine.textContent = "";
        publicMilesLine.textContent = "";
        publicKwhLine.textContent = "";
        adhocCostLine.textContent = "";
        blendedCostLine.textContent = "";
        blendedCostPerMileLine.textContent = "";
        if (tableBody) tableBody.innerHTML = "";
        document.getElementById("results").style.display = "none";
        if (chart) chart.destroy();
        return;
    }

    if (core.cheapHome) {
        homeRangeLine.innerHTML =
            `Estimated range from home charge: <span class="highlight">${core.homeMiles.toFixed(0)} miles</span>`;
        if (core.homeRate > 0 && core.homeKwh > 0) {
            homeCostLine.innerHTML =
                `Home charging energy: <span class="highlight">${core.homeKwh.toFixed(1)} kWh</span>, ` +
                `cost: <span class="highlight">£${core.homeCost.toFixed(2)}</span>`;
        } else if (core.homeKwh > 0) {
            homeCostLine.innerHTML =
                `Home charging energy: <span class="highlight">${core.homeKwh.toFixed(1)} kWh</span> (no home rate entered).`;
        } else {
            homeCostLine.textContent = "";
        }
    } else {
        homeRangeLine.innerHTML = `Home charging disabled — full journey requires public charging.`;
        homeCostLine.textContent = "";
    }

    publicMilesLine.innerHTML =
        `Miles requiring public charging: <span class="highlight">${core.publicMiles.toFixed(0)} miles</span>`;
    publicKwhLine.innerHTML =
        `Energy from public charging: <span class="highlight">${core.publicKwh.toFixed(1)} kWh</span>`;
    adhocCostLine.innerHTML =
        `Cost using ad‑hoc only (public portion): <span class="highlight">£${core.adhocCost.toFixed(2)}</span>`;

    blendedCostLine.innerHTML =
        `Total blended trip cost (home + public): <span class="highlight">£${core.blendedAdhocTripCost.toFixed(2)}</span>`;
    blendedCostPerMileLine.innerHTML =
        `Effective ad‑hoc cost per mile: <span class="highlight">${(core.blendedAdhocCostPerMile * 100).toFixed(1)} p/mile</span>`;

    const providers = [];
    const boxes = document.querySelectorAll(".provider-box");

    boxes.forEach(box => {
        const id = box.dataset.id;
        const name = document.getElementById(`name${id}`).value.trim();
        const subCost = parseFloat(document.getElementById(`subCost${id}`).value);
        const discountPence = parseFloat(document.getElementById(`discount${id}`).value);

        if (!name || isNaN(subCost) || isNaN(discountPence)) return;

        const discountRate = discountPence / 100;

        const costWithSubPublicOnly = subCost + (core.publicKwh * discountRate);
        const breakEvenKwh = (core.adhocRate > discountRate)
            ? subCost / (core.adhocRate - discountRate)
            : Infinity;
        const breakEvenMiles = (breakEvenKwh === Infinity)
            ? Infinity
            : breakEvenKwh * core.efficiency;

        const blendedTripCost = core.homeCost + costWithSubPublicOnly;
        const blendedCostPerMile = blendedTripCost / core.journeyMiles;
        const blendedSavingsVsAdhoc = core.blendedAdhocTripCost - blendedTripCost;

        providers.push({
            name,
            subCost,
            discountPence,
            breakEvenMiles,
            blendedTripCost,
            blendedCostPerMile,
            blendedSavingsVsAdhoc
        });
    });

    if (providers.length === 0) {
        document.getElementById("results").style.display = "none";
        if (tableBody) tableBody.innerHTML = "";
        if (chart) chart.destroy();
        return;
    }

    document.getElementById("results").style.display = "block";

    const best = providers.reduce((a, b) => (a.blendedTripCost < b.blendedTripCost ? a : b));
    const summaryBox = document.getElementById("summaryBox");

    if (best.blendedTripCost < core.blendedAdhocTripCost) {
        summaryBox.className = "summary good";
        summaryBox.textContent =
            `${best.name} is the cheapest option for this trip (saving £${(core.blendedAdhocTripCost - best.blendedTripCost).toFixed(2)} vs ad‑hoc).`;
    } else {
        summaryBox.className = "summary bad";
        summaryBox.textContent =
            `Ad‑hoc charging (with your home rate) is cheaper than any subscription for this trip.`;
    }

    renderProviderTable(core, providers);
    drawGraph(core, providers);
}

<!-- =========================================================
     TABLE RENDERING (first half)
========================================================= -->
function renderProviderTable(core, providers) {
    const tbody = document.querySelector("#providerTable tbody");
    if (!tbody) return;

    const sortBy = document.getElementById("sortBy")?.value || "cost";
    const showTotal = document.getElementById("showTotalBreakEven")?.checked || false;

    const sorted = [...providers];

    sorted.sort((a, b) => {
        if (sortBy === "cost") return a.blendedTripCost - b.blendedTripCost;
        if (sortBy === "breakeven") {
            if (a.breakEvenMiles === b.breakEvenMiles) return 0;
            if (a.breakEvenMiles === Infinity) return 1;
            if (b.breakEvenMiles === Infinity) return -1;
            return a.breakEvenMiles - b.breakEvenMiles;
        }
        if (sortBy === "savings") return b.blendedSavingsVsAdhoc - a.blendedSavingsVsAdhoc;
        return 0;
    });

    tbody.innerHTML = "";
/* =========================================================
   GRAPH (blended cost vs distance)
========================================================= */
function drawGraph(core, providers) {
    const ctx = document.getElementById("costChart");

    if (chart) chart.destroy();

    const maxMiles = core.journeyMiles;
    const steps = 20;

    const labels = [];
    const adhocData = [];

    for (let i = 0; i <= steps; i++) {
        const m = (maxMiles * i) / steps;
        labels.push(m.toFixed(0));

        const homeMilesAtM = core.cheapHome ? Math.min(core.homeMiles, m) : 0;
        const publicMilesAtM = Math.max(0, m - homeMilesAtM);
        const homeKwhAtM = homeMilesAtM / core.efficiency;
        const publicKwhAtM = publicMilesAtM / core.efficiency;

        const homeCostAtM = homeKwhAtM * core.homeRate;
        const adhocCostAtM = publicKwhAtM * core.adhocRate;

        const blendedAdhocAtM = homeCostAtM + adhocCostAtM;

        adhocData.push(blendedAdhocAtM);
    }

    const datasets = [{
        label: "Ad‑hoc (home + public) (£)",
        data: adhocData,
        borderColor: "#f97316",
        backgroundColor: "rgba(249,115,22,0.15)",
        tension: 0.2
    }];

    providers.forEach((p, idx) => {
        const colors = ["#38bdf8", "#4ade80", "#a855f7", "#facc15", "#f472b6", "#22c55e"];
        const color = colors[idx % colors.length];

        const data = [];

        for (let i = 0; i <= steps; i++) {
            const m = (maxMiles * i) / steps;

            const homeMilesAtM = core.cheapHome ? Math.min(core.homeMiles, m) : 0;
            const publicMilesAtM = Math.max(0, m - homeMilesAtM);
            const homeKwhAtM = homeMilesAtM / core.efficiency;
            const publicKwhAtM = publicMilesAtM / core.efficiency;

            const homeCostAtM = homeKwhAtM * core.homeRate;
            const subCostAtM = p.subCost + (publicKwhAtM * (p.discountPence / 100));

            const blendedAtM = homeCostAtM + subCostAtM;

            data.push(blendedAtM);
        }

        datasets.push({
            label: `${p.name} (£)`,
            data,
            borderColor: color,
            backgroundColor: "transparent",
            tension: 0.2
        });
    });

    chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
                x: { title: { display: true, text: "Trip distance (miles)" } },
                y: { title: { display: true, text: "Total blended trip cost (£)" }, beginAtZero: true }
            }
        }
    });
}

/* =========================================================
   SHAREABLE LINK
========================================================= */
function shareLink() {
    const core = getCoreInputs();
    if (!core) {
        alert("Please fill in all main inputs first.");
        return;
    }

    const params = new URLSearchParams();

    params.set("jm", core.journeyMiles);
    params.set("bk", core.batteryKwh);
    params.set("soc", core.soc);
    params.set("eff", core.efficiency);
    params.set("adhoc", core.adhocPence);
    if (core.homeRatePence !== null) params.set("hr", core.homeRatePence);
    params.set("ch", core.cheapHome ? "1" : "0");

    let idx = 0;
    document.querySelectorAll(".provider-box").forEach(box => {
        const id = box.dataset.id;

        const name = document.getElementById(`name${id}`).value.trim();
        const subCost = document.getElementById(`subCost${id}`).value;
        const discount = document.getElementById(`discount${id}`).value;

        if (!name || !subCost || !discount) return;

        params.set(`p${idx}n`, name);
        params.set(`p${idx}s`, subCost);
        params.set(`p${idx}r`, discount);

        idx++;
    });

    const base = window.location.href.split("?")[0];
    const url = `${base}?${params.toString()}`;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(
            () => alert("Link copied to clipboard."),
            () => prompt("Copy this link:", url)
        );
    } else {
        prompt("Copy this link:", url);
    }
}

/* =========================================================
   LOAD FROM URL
========================================================= */
function loadFromParams() {
    const params = new URLSearchParams(window.location.search);

    if (!params.has("jm")) return;

    const setVal = (id, key) => {
        const v = params.get(key);
        if (v !== null) document.getElementById(id).value = v;
    };

    setVal("journeyMiles", "jm");
    setVal("batteryKwh", "bk");
    setVal("soc", "soc");
    setVal("efficiency", "eff");
    setVal("adhoc", "adhoc");
    setVal("homeRate", "hr");

    const ch = params.get("ch");
    document.getElementById("cheapHome").checked = (ch === "1");

    let idx = 0;
    while (true) {
        const name = params.get(`p${idx}n`);
        const sub = params.get(`p${idx}s`);
        const rate = params.get(`p${idx}r`);

        if (!name || !sub || !rate) break;

        createProviderBox();
        const id = providerCount;

        document.getElementById(`name${id}`).value = name;
        document.getElementById(`subCost${id}`).value = sub;
        document.getElementById(`discount${id}`).value = rate;

        idx++;
    }

    calculate();
}

/* =========================================================
   PDF EXPORT
========================================================= */
async function exportPdf() {
    const resultsEl = document.getElementById("results");
    if (!resultsEl || resultsEl.style.display === "none") {
        alert("Please enter inputs and providers so results are visible before exporting.");
        return;
    }

    resultsEl.scrollIntoView();
    await new Promise(r => setTimeout(r, 300));

    const { jsPDF } = window.jspdf;

    const canvas = await html2canvas(document.body, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
    });

    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    pdf.save("ev-charging-comparison.pdf");
}

/* =========================================================
   INITIALISE
========================================================= */
["journeyMiles","batteryKwh","soc","efficiency","adhoc","homeRate"].forEach(id => {
    document.getElementById(id).addEventListener("input", calculate);
});
document.getElementById("cheapHome").addEventListener("change", calculate);
document.getElementById("sortBy").addEventListener("change", calculate);
document.getElementById("showTotalBreakEven").addEventListener("change", calculate);

initTheme();
addProvider();
loadFromParams();
</script>
</body>
</html>
